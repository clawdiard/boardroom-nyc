name: Process Reservation
on:
  repository_dispatch:
    types: [reservation]

permissions:
  contents: write

jobs:
  reserve:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update product status
        run: |
          PRODUCT_ID="${{ github.event.client_payload.product_id }}"
          SHOP_SLUG="${{ github.event.client_payload.shop_slug }}"
          FILE="data/products/${SHOP_SLUG}/${PRODUCT_ID}.json"

          if [ ! -f "$FILE" ]; then
            echo "Product file not found: $FILE"
            exit 1
          fi

          # Update status to reserved and add timestamp
          jq --arg now "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            '.status = "reserved" | .reserved_at = $now' \
            "$FILE" > "${FILE}.tmp" && mv "${FILE}.tmp" "$FILE"

          echo "Reserved: $FILE"
          cat "$FILE"

      - name: Commit and push
        run: |
          git config user.name "boardroom-bot"
          git config user.email "bot@boardroom-nyc.com"
          git add data/
          git diff --cached --quiet && echo "No changes" && exit 0
          git commit -m "reserve: ${{ github.event.client_payload.product_id }} at ${{ github.event.client_payload.shop_slug }}"
          git push
